### **ペイウォール実装計画**

#### **フェーズ 1: ペイウォール画面の UI 実装 (モックデータ使用)**

1.  **ファイル作成**:

    - 新しい画面として `src/app/paywall.tsx` を作成します。

2.  **UI コンポーネントの実装**:

    - ご提示いただいた画像を参考に、以下のコンポーネントで画面を構成します。プロジェクトの既存の配色（オレンジやグレー）に合わせてスタイリングします。
      - **ヘッダー**: タイトル (`Unlock Unlimited Access` など) と、後述する「閉じるボタン」。
      - **機能リスト**: 有料プランでアンロックされる機能のリスト（チェックマーク付き）。
      - **プラン選択エリア**: この時点では、料金プランの情報は **モックデータ（ハードコードされたオブジェクト）** を使用して表示します。
      - **購入ボタン**: 購入ボタンの `onPress` ハンドラは、当面は空の関数またはコンソールログを出すだけにします。
      - **フッター**: 利用規約、プライバシーポリシー、購入の復元(`Restore`)へのリンクを配置します。

3.  **「閉じるボタン」の遅延表示**:

    - `useEffect` と `setTimeout` を利用します。
    - 画面が表示されてから 5 秒後に、ヘッダーに「閉じる」ボタン（'×'アイコンなど）を表示させるロジックを実装します。

#### **フェーズ 2: 環境構築とライブラリ導入**

1.  **RevenueCat SDK の導入**:

    - `react-native-purchases` (RevenueCat の公式ライブラリ) をプロジェクトにインストールします。
    - これに伴い、ネイティブコードの利用が必要になるため、`expo-dev-client` を導入し、開発ビルドでアプリを実行する環境を整えます。

2.  **RevenueCat と各アプリストアの設定**:

    - RevenueCat の管理画面でプロジェクトを作成します。
    - Apple Developer Program と Google Play Console でアプリ情報を登録します。
    - **料金プランの設定**:
      - **Entitlement（権利）**: `premium` のような名前で、有料ユーザーとしての権利を定義します。
      - **Offerings（提供パッケージ）**:
        - `default` という名前のパッケージを作成します。
        - このパッケージ内に、以下の 3 つの**Product（製品）**を紐付けます。
          1.  **3 日間無料トライアル付き年額プラン**
          2.  **月額プラン**
          3.  **年額プラン** (トライアルなし)
    - 設定が完了したら、RevenueCat の API キーをアプリ内に設定します。

#### **フェーズ 3: 購入状態のグローバル管理**

1.  **購入情報 Context の作成**:

    - ユーザーの購入状態（有料会員か否か、利用可能なプランなど）をアプリのどこからでも参照・更新できるように、React の Context API (`PurchaseProvider`) を作成します。
    - この Provider は、アプリの最も親のコンポーネント（`src/app/_layout.tsx`）で全体をラップします。

2.  **Provider の機能**:

    - アプリ起動時に RevenueCat の SDK を初期化します。
    - ユーザーの購入情報を非同期で取得し、Context 内で保持します。
    - 以下の情報と機能を子コンポーネントに提供します。
      - `isProMember` (boolean): 有料会員かどうか。
      - `offerings`: 購入可能な料金プランのリスト。
      - `purchasePackage()`: 購入処理を実行する関数。
      - `restorePurchases()`: 購入情報を復元する関数。
      - `isLoading`: 情報を読み込み中かどうかの状態。

#### **フェーズ 4: ペイウォール画面と購入ロジックの連携**

1.  **モックデータの置き換え**:

    - `src/app/paywall.tsx` で、フェーズ 3 で作成した `PurchaseProvider` から `offerings` を取得し、フェーズ 1 で使用したモックデータを置き換えます。

2.  **購入処理の接続**:

    - 購入ボタンの `onPress` で `purchasePackage` を呼び出すようにします。
    - 復元リンクの `onPress` で `restorePurchases` を呼び出すようにします。

#### **フェーズ 5: 画面遷移ロジックの更新**

1.  **オンボーディング完了からの遷移**:

    - `src/app/onboarding.tsx` 内の `completeOnboarding` 関数を修正します。
    - ユーザーデータの保存が成功した後、`router.replace("/(tabs)")` でホーム画面に遷移していた部分を、`router.push("/paywall")` に変更し、ペイウォール画面に遷移させます。

2.  **ペイウォール画面からの遷移**:

    - 購入が成功した場合、またはユーザーが「閉じる」ボタンを押した場合、`router.replace("/(tabs)")` を実行してホーム画面に遷移させます。これにより、ユーザーはペイウォール画面に後戻りできなくなります。

3.  **アプリ起動時の遷移ロジック**:

    - `src/app/_layout.tsx` の既存ロジックは基本的に維持します。
    - つまり、アプリ起動時にオンボーディングが完了しているユーザーは、直接ホーム画面 `/(tabs)` に遷移します。ペイウォールは、オンボーディング完了直後や、設定画面など特定の箇所から遷移する画面として位置付けます。

---

#### **ご質問への回答**

> **有料プランに登録済みかどうかを判定するためには、 `schema.ts` を更新する必要はありますか？**

**結論から言うと、必須ではありません。**

- RevenueCat を導入する場合、ユーザーの購入状態（どのプランに加入中か、有効期限はいつか等）はすべて RevenueCat のサーバーで管理されます。
- アプリは、`PurchaseProvider` を通じてリアルタイムに RevenueCat へ問い合わせ、`isProMember` のような形で最新の情報を取得できます。これにより、ユーザーが別デバイスで購入を復元した場合なども即座に反映されます。
- ローカルのデータベース（`drizzle/schema.ts`）に `isSubscribed` のようなカラムを追加する必要はなく、データ管理がシンプルになるというメリットがあります。
