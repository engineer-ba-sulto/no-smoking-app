# T1-4-3: テストデータの投入と動作確認

## 概要

`T1-4-2` で実装したシーディングスクリプトが、期待通りに正しく動作するかを検証する。手動でのコマンド実行による動作確認と、Jest などを用いた自動テストの両方を実施し、シーディング機能の品質を保証する。

## 目的

- 実装したシーディングスクリプト (`db:seed` コマンド群) がエラーなく実行できることを確認する。
- データベースに意図した通りのデータが投入・削除されることを確認する。
- シーディング関連のロジック（データ生成、DB 操作）に対する単体テストを実装し、将来のリファクタリングに対する安全性を確保する。

## 依存関係

- **親タスク**: T1-4-0 (開発用データのシーディング)
- **依存タスク**: T1-4-2 (シーディングスクリプトの実装)
- **担当領域**: 開発効率, QA

## 実装詳細

### 1. 手動での動作確認

ターミナルから `package.json` に登録した npm スクリプトを実際に実行し、動作を確認する。

- **`bun run db:seed:clean`**
  - 実行後、`bun run db:seed:verify` を叩き、`Found 0 user profiles` と表示されることを確認する。
- **`bun run db:seed:basic`**
  - 実行後、`verify` コマンドで `testDataSets.basicSet` の件数分データが投入されていることを確認する。
- **`bun run db:seed:all`**
  - 実行後、`verify` コマンドで全静的データセットの合計件数が投入されていることを確認する。
- **データベースクライアントでの目視確認**
  - Drizzle Studio や SQLite の GUI ツールを使い、`no-smoking-app.db` ファイルの中身を直接確認する。投入されたデータが `test-data-sets.ts` の定義と一致しているかを目視でチェックする。

### 2. 自動テストの実装

`src/drizzle/seeders/__tests__/seeder.test.ts` ファイルを作成し、シーディング関連ロジックの単体テストを実装する。テストフレームワークは Jest を想定する。

#### テストのセットアップ

- テスト実行用にインメモリの SQLite データベースを使用するか、テストごとにファイルをクリーンアップする設定を行う。
- `beforeEach` で `mainSeeder.clearAllData()` を実行し、各テストケースが独立した状態から始まるようにする。

#### テストケースの例

- **`DummyDataGenerator` のテスト**
  - `createRandomUserProfile` が `CreateUserProfileInput` 型に準拠したオブジェクトを返すことをテストする。
  - 各プロパティの値が期待される範囲内（例: `cigsPerDay` が 5〜40）であることをアサーションする。
- **`MainSeeder` のテスト**
  - `seedFromDataSet` を実行した後、`userProfileRepository.findAll()` で取得した件数と内容が、投入したデータセットと一致することをテストする。
  - `clearAllData` を実行した後、`findAll` の結果が空配列 `[]` になることをテストする。
  - `seedRandomData(5)` を実行した後、`findAll` で取得した件数が 5 件であることをテストする。

## 実装手順

1. ターミナルを開き、`package.json` に定義した `db:seed:*` コマンドを一つずつ実行し、エラーが発生しないか、`verify` の結果が期待通りかを確認する。
2. `bun add -d jest @types/jest ts-jest` コマンドで Jest 関連のパッケージをインストールする。
3. `jest.config.js` をプロジェクトルートに作成し、TypeScript を扱えるように設定する。
4. `src/drizzle/seeders/__tests__/seeder.test.ts` を作成する。
5. 上記「テストケースの例」を参考に、データ生成ロジックとシーディング実行ロジックの単体テストを記述する。
6. `bun test` コマンドを実行し、すべてのテストがパスすることを確認する。

## 完了条件

- [ ] `package.json` に追加したすべての `db:seed:*` スクリプトが、手動実行でエラーなく動作する。
- [ ] `verify` コマンドやデータベースクライアントでの目視確認により、データが正しく投入・削除されていることが確認済みである。
- [ ] データ生成ロジックおよびシーディング実行ロジックに対する単体テストが実装されている。
- [ ] `bun test` を実行した際に、すべてのシーディング関連テストが成功する。

## 次のタスク

- **T2-1**: 日付計算ユーティリティの作成
