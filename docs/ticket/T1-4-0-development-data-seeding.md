# T1-4-0: 開発用データのシーディング

## 概要

T1-3 で実装したデータリポジトリ層を利用して、開発およびテスト用のダミーデータをデータベースに投入（シーディング）する機能を構築する。この機能により、オンボーディング機能が未実装の段階でも、UI の表示確認やビジネスロジックのテストを効率的に進めることが可能になる。

## 目的

- 手動でのデータ入力の手間を省き、開発効率を大幅に向上させる。
- 正常系、境界値、特定シナリオ（アチーブメント達成など）を網羅したテストデータを簡単に用意できるようにする。
- 誰でも同じデータセットでテストを実行できる環境を整え、再現性を担保する。

## 依存関係

- **依存タスク**: `T1-3` (データ操作用リポジトリ層の実装)
- **担当領域**: 開発効率

## サブチケット

- **T1-4-1**: ダミーデータ生成ロジックの実装
- **T1-4-2**: シーディングスクリプトの実装
- **T1-4-3**: テストデータの投入と動作確認

---

## T1-4-1: ダミーデータ生成ロジックの実装

### 方針

- `user_profile`テーブルのスキーマに合わせたダミーデータを生成する純粋な関数群を実装する。
- このロジックは、シーディングスクリプト本体や将来のテストコードから再利用可能になるよう、特定のフレームワークに依存しない形で作成する。

### 実装詳細

1.  **データ生成クラスの作成 (`src/drizzle/seeders/dummy-data-generator.ts`)**

    - ランダムな値を持つユーザープロファイル（`CreateUserProfileInput`型）を生成するメソッドを実装する。
      - 喫煙開始日: 過去 1 年以内のランダムな日付
      - 1 日の喫煙本数: 5〜40 本の範囲のランダムな整数
      - タバコ 1 箱の価格: 500〜800 円の範囲のランダムな数値
      - 1 箱の本数: 20 本（固定）または `[10, 20, 25]` からランダムに選択
    - 特定のテストシナリオに基づいたデータを生成するメソッドを実装する。
      - **初心者:** 禁煙開始から 1 日
      - **中級者:** 禁煙開始から 1 週間
      - **上級者:** 禁煙開始から 1 ヶ月
      - **ヘビースモーカー:** 喫煙本数や期間が多いユーザー

2.  **テストデータセットの定義 (`src/drizzle/seeders/test-data-sets.ts`)**
    - 静的なテストデータセットをオブジェクトとして定義し、いつでも同じデータでテストできるようにする。
    - 以下のカテゴリのデータセットを用意する。
      - **基本データ:** UI の基本的な表示確認に使用する数件のデータ。
      - **境界値データ:** 禁煙開始直後（1 分前）、長期間（1 年前）など、計算ロジックのエッジケースを確認するためのデータ。
      - **アチーブメントテスト用データ:** 各アチーブメント（1 日達成、3 日達成、1 週間達成など）をテストするためのデータ。

---

## T1-4-2: シーディングスクリプトの実装

### 方針

- `T1-4-1` で作成したデータ生成ロジックを使い、実際にデータベースへデータを投入するスクリプトを実装する。
- コマンドラインから `tsx` を使って実行できるようにし、引数によって投入するデータの種類を切り替えられるようにする。

### 実装詳細

1.  **メインシーダークラスの作成 (`src/drizzle/seeders/main-seeder.ts`)**

    - `UserProfileRepository` を内部で利用し、データベース操作を行う。
    - 以下の責務を持つメソッドを実装する。
      - `clearAllData()`: `user_profile` テーブルを空にする。
      - `seedBasicData()`: 基本データセットを投入する。
      - `seedEdgeCaseData()`: 境界値データセットを投入する。
      - `seedAchievementTestData()`: アチーブメントテスト用データを投入する。
      - `seedRandomData(count: number)`: 指定された件数だけランダムデータを投入する。
      - `seedAll()`: 全てのデータを一度に投入する（クリア → 各データセット投入）。
      - `verify()`: 現在データベースに格納されているデータ件数や内容をコンソールに出力して確認する。

2.  **実行スクリプトの作成 (`src/drizzle/seeders/run-seeder.ts`)**

    - Node.js のコマンドライン引数 (`process.argv`) を解釈し、`MainSeeder` の適切なメソッドを呼び出す。
    - 引数なしの場合は `seedAll()` を実行するなど、デフォルトの挙動を定義する。

3.  **`package.json` へのスクリプト追加**

    - `npm run` や `bun run` で簡単にシーディングを実行できるよう、`scripts` にコマンドを登録する。

    ```json
    "scripts": {
      "db:seed": "tsx src/drizzle/seeders/run-seeder.ts",
      "db:seed:all": "tsx src/drizzle/seeders/run-seeder.ts all",
      "db:seed:clean": "tsx src/drizzle/seeders/run-seeder.ts clean",
      "db:seed:verify": "tsx src/drizzle/seeders/run-seeder.ts verify"
    }
    ```

---

## T1-4-3: テストデータの投入と動作確認

### 方針

- 実装したシーディングスクリプトが想定通りに動作することを、手動実行と自動テストの両面から確認する。

### 実装詳細

1.  **手動での動作確認**

    - `package.json` に追加した各種 `db:seed` コマンドを実行し、コンソールにエラーが出力されないことを確認する。
    - `db:seed:verify` を実行し、想定した件数のデータが投入されていることを確認する。
    - 可能であれば、データベースクライアントツールで `development.db` を開き、実際のデータが格納されていることを目視で確認する。

2.  **自動テストの実装 (`src/drizzle/seeders/__tests__/seeder.test.ts`)**
    - `jest` や `vitest` などのテストフレームワークを使用し、シーディングロジックの単体テストを作成する。
    - テストケースの例:
      - `DummyDataGenerator` がスキーマに準拠した正しい型のデータを生成すること。
      - `MainSeeder` の `seedBasicData` を実行後、`userProfileRepository.findAll()` で取得した件数が期待値と一致すること。
      - `clearAllData` を実行後、データ件数が 0 になること。
    - 各テストの前後でデータベースの状態をクリーンにする（`beforeEach`, `afterEach` でクリア処理を挟む）。

## 完了条件

- `T1-4-1`
  - [ ] ランダムなユーザープロファイルを生成するロジックが実装されている。
  - [ ] 特定のシナリオに基づいたユーザープロファイルを生成するロジックが実装されている。
  - [ ] テストで使用する静的なデータセットが定義されている。
- `T1-4-2`
  - [ ] データベースのクリア、各種データの投入、投入結果の確認を行う `MainSeeder` クラスが実装されている。
  - [ ] コマンドライン引数に応じて `MainSeeder` を実行するスクリプトが実装されている。
  - [ ] `package.json` にシーディング関連のコマンドが追加されている。
- `T1-4-3`
  - [ ] 追加した npm スクリプトがエラーなく実行できることを確認済みである。
  - [ ] シーディングロジックに関する単体テストが実装され、すべてパスしている。

## 次のタスク

- **`T2-1`**: 日付計算ユーティリティの作成
