# T1-2-1: 現在のスキーマ分析と要件整理

## 概要

既存の`user_profile`テーブルのスキーマ定義を詳細に分析し、機能要件定義書で定められた必須の 3 大機能（F01, F02, F03）との対応関係を整理する。不足している項目や改善点を特定し、次のステップでのスキーマ拡張設計に必要な情報を整理する。

## 目的

- 現在のスキーマ定義の詳細分析
- 機能要件との対応関係の明確化
- 不足しているデータ項目の特定
- スキーマ改善点の洗い出し

## 依存関係

- **依存タスク**: T1-1（Drizzle ORM と Expo SQLite の導入・設定）
- **担当領域**: データベース設計

## 実装詳細

### 1. 現在のスキーマ定義の分析

```typescript
export const userProfile = sqliteTable("user_profile", {
  id: integer("id").primaryKey({ autoIncrement: true }),
  smokingStartDate: text("smoking_start_date").notNull(), // ISO文字列
  cigsPerDay: integer("cigs_per_day").notNull(),
  pricePerPack: real("price_per_pack").notNull(),
  cigsPerPack: integer("cigs_per_pack").notNull(),
  createdAt: text("created_at").notNull().default("CURRENT_TIMESTAMP"),
  updatedAt: text("updated_at").notNull().default("CURRENT_TIMESTAMP"),
});
```

### 2. 各フィールドの詳細分析

#### `id`フィールド

- **型**: `integer` (Primary Key, Auto Increment)
- **用途**: レコードの一意識別
- **状態**: ✅ 適切

#### `smokingStartDate`フィールド

- **型**: `text` (ISO 文字列)
- **用途**: 禁煙開始日時の記録
- **機能要件対応**: F01（継続時間計算）、F03（時間ベースアチーブメント）
- **状態**: ✅ 適切

#### `cigsPerDay`フィールド

- **型**: `integer`
- **用途**: 1 日の喫煙本数
- **機能要件対応**: F01（我慢した本数計算）、F03（本数ベースアチーブメント）
- **状態**: ✅ 適切

#### `pricePerPack`フィールド

- **型**: `real`
- **用途**: タバコ 1 箱の価格
- **機能要件対応**: F01（節約金額計算）、F03（金額ベースアチーブメント）
- **状態**: ✅ 適切

#### `cigsPerPack`フィールド

- **型**: `integer`
- **用途**: 1 箱の本数
- **機能要件対応**: F01（節約金額計算）、F03（金額ベースアチーブメント）
- **状態**: ✅ 適切

#### `createdAt`フィールド

- **型**: `text` (CURRENT_TIMESTAMP)
- **用途**: レコード作成日時
- **状態**: ✅ 適切

#### `updatedAt`フィールド

- **型**: `text` (CURRENT_TIMESTAMP)
- **用途**: レコード更新日時
- **状態**: ⚠️ 自動更新機能が必要

### 3. 機能要件との対応関係

#### F01（見える化機能）

| 表示項目               | 必要なデータ                                | 現在のスキーマ | 状態 |
| ---------------------- | ------------------------------------------- | -------------- | ---- |
| 禁煙継続時間カウンター | `smokingStartDate`                          | ✅ あり        | 完備 |
| 節約金額カウンター     | `pricePerPack`, `cigsPerPack`, `cigsPerDay` | ✅ あり        | 完備 |
| 我慢した本数カウンター | `cigsPerDay`, `smokingStartDate`            | ✅ あり        | 完備 |

#### F02（対処法サポート機能）

| 機能       | 必要なデータ         | 現在のスキーマ | 状態 |
| ---------- | -------------------- | -------------- | ---- |
| 対処法表示 | なし（ハードコード） | -              | 不要 |

#### F03（アチーブメント機能）

| 判定タイプ | 必要なデータ                                                    | 現在のスキーマ | 状態 |
| ---------- | --------------------------------------------------------------- | -------------- | ---- |
| 時間ベース | `smokingStartDate`                                              | ✅ あり        | 完備 |
| 本数ベース | `cigsPerDay`, `smokingStartDate`                                | ✅ あり        | 完備 |
| 金額ベース | `pricePerPack`, `cigsPerPack`, `cigsPerDay`, `smokingStartDate` | ✅ あり        | 完備 |

### 4. 改善点の特定

#### 必須の改善点

1. **`updatedAt`フィールドの自動更新**
   - 現在は`CURRENT_TIMESTAMP`で固定
   - レコード更新時に自動で現在時刻に更新される仕組みが必要

#### 検討すべき追加項目

1. **ユーザー識別情報**

   - ユーザー名やニックネーム
   - アバター画像のパス

2. **アプリ設定情報**

   - 通知設定
   - テーマ設定
   - 言語設定

3. **統計情報**
   - 最終ログイン日時
   - アプリ使用回数

## 実装手順

1. **スキーマファイルの詳細確認**

   ```bash
   # 現在のスキーマ定義を確認
   cat src/drizzle/schema.ts
   ```

2. **機能要件との対応表作成**

   - 各機能で使用されるデータ項目を整理
   - 不足項目の特定

3. **改善点の整理**

   - 必須の改善点を優先度順に整理
   - 追加検討項目の必要性を評価

4. **次のステップの準備**
   - スキーマ拡張設計に必要な情報をまとめ
   - マイグレーション戦略の検討

## 完了条件

- [ ] 現在のスキーマ定義の詳細分析が完了している
- [ ] 各フィールドの用途と機能要件との対応関係が明確になっている
- [ ] 不足している項目や改善点が特定されている
- [ ] 機能要件 F01, F02, F03 との対応表が作成されている
- [ ] 次のステップ（スキーマ拡張設計）に必要な情報が整理されている

## 次のタスク

- **T1-2-2**: 機能要件に基づくスキーマ拡張
- **依存関係**: このタスクの完了後に実行可能

## トラブルシューティング

### よくある問題

1. **スキーマファイルが見つからない**

   ```bash
   # プロジェクトルートから確認
   find . -name "schema.ts" -type f
   ```

2. **機能要件との対応関係が不明確**
   - 機能要件定義書を再確認
   - 各機能で使用されるデータ項目を詳細に分析

## 備考

- 現在のスキーマは基本的な機能要件を満たしている
- 主な改善点は`updatedAt`フィールドの自動更新機能
- 追加項目は将来的な機能拡張を考慮した検討が必要
